<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Teleprompter Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial, sans-serif}
body{background:#000;color:white;overflow:hidden}

/* EDITOR */
#editor-container{height:20vh}
#editor{
  width:100%;
  height:100%;
  padding:15px;
  font-size:16px;
  background:#111;
  color:white;
  border:none;
  resize:none;
}

/* VIDEO */
#stage{position:relative;height:80vh}
video{
  position:absolute;
  width:100%;
  height:100%;
  object-fit:cover;
}

/* TELEPROMPTER – SOLO 3 LINEAS */
#reading-zone{
  position:absolute;
  width:100%;
  height:120px;
  overflow:hidden;
  text-align:center;
  top:40%;
}

#teleprompter{
  font-size:40px;
  line-height:40px;
  max-width:85%;
  margin:auto;
  white-space:pre-wrap;
  text-shadow:0 0 15px rgba(0,0,0,.9);
  transform:translateY(0);
}

/* CONTROLES */
.controls{
  position:fixed;
  bottom:40px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:15px;
}

button{
  width:60px;
  height:60px;
  border-radius:50%;
  border:none;
  font-size:20px;
  cursor:pointer;
}

.play{background:#444;color:white}
.stop{background:#666;color:white}
.rec{background:red;color:white}
.stoprec{background:#999;color:black}

/* CUENTA REGRESIVA */
#countdown{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:120px;
  font-weight:bold;
  background:rgba(0,0,0,.6);
  opacity:0;
  transition:.3s;
}
#countdown.show{opacity:1}
</style>
</head>

<body>

<div id="editor-container">
<textarea id="editor">
“La Isapre es más cara…”

Depende.

Si ganas 1.800.000,
tu 7% son 126.000.

Con eso puedes tener acceso
a clínicas privadas,
reembolsos en menos de 48 horas,
y beneficios adicionales.

No es más caro.
Es distinto.
</textarea>
</div>

<div id="stage">
<video id="camera" autoplay playsinline muted></video>

<div id="reading-zone">
<div id="teleprompter"></div>
</div>

<div id="countdown">5</div>
</div>

<div class="controls">
<button class="play" id="playBtn">▶</button>
<button class="stop" id="stopBtn">⏹</button>
<button class="rec" id="recBtn">●</button>
<button class="stoprec" id="stopRecBtn">■</button>
</div>

<script>
let speed = 120
let y = 0
let isPlaying = false
let lastTime = null
let mediaRecorder = null
let recordedChunks = []
let countdownValue = 5

const tele = document.getElementById("teleprompter")
const readingZone = document.getElementById("reading-zone")
const video = document.getElementById("camera")
const countdownEl = document.getElementById("countdown")

const playBtn = document.getElementById("playBtn")
const stopBtn = document.getElementById("stopBtn")
const recBtn = document.getElementById("recBtn")
const stopRecBtn = document.getElementById("stopRecBtn")

playBtn.addEventListener("click", play)
stopBtn.addEventListener("click", stopScroll)
recBtn.addEventListener("click", startCountdown)
stopRecBtn.addEventListener("click", stopRecording)

/* CAMARA */
async function initCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true})
    video.srcObject = stream
    window.stream = stream
  }catch(e){
    console.log("Permiso cámara/micrófono rechazado")
  }
}
initCamera()

/* PLAY */
function play(){
  const raw = document.getElementById("editor").value
  if(!raw.trim()) return

  tele.innerText = raw

  y = readingZone.offsetHeight + 150
  tele.style.transform = `translateY(${y}px)`

  isPlaying = true
  lastTime = null
  requestAnimationFrame(loop)
}

function stopScroll(){
  isPlaying = false
}

/* SCROLL SUAVE */
function loop(timestamp){
  if(!isPlaying) return
  if(!lastTime) lastTime = timestamp
  const delta = (timestamp - lastTime)/1000
  lastTime = timestamp

  y -= speed * delta
  tele.style.transform = `translateY(${y}px)`

  requestAnimationFrame(loop)
}

/* CUENTA REGRESIVA */
function startCountdown(){
  countdownValue = 5
  countdownEl.innerText = countdownValue
  countdownEl.classList.add("show")

  const interval = setInterval(()=>{
    countdownValue--
    countdownEl.innerText = countdownValue

    if(countdownValue <= 0){
      clearInterval(interval)
      countdownEl.classList.remove("show")
      startRecording()
    }
  },1000)
}

/* GRABACION */
function startRecording(){
  if(!window.stream) return
  recordedChunks = []
  mediaRecorder = new MediaRecorder(window.stream)

  mediaRecorder.ondataavailable = e=>{
    if(e.data.size > 0) recordedChunks.push(e.data)
  }

  mediaRecorder.onstop = ()=>{
    const blob = new Blob(recordedChunks,{type:"video/webm"})
    const url = URL.createObjectURL(blob)
    const a = document.createElement("a")
    a.href = url
    a.download = "video_"+Date.now()+".webm"
    a.click()
  }

  mediaRecorder.start()
}

function stopRecording(){
  if(mediaRecorder && mediaRecorder.state !== "inactive"){
    mediaRecorder.stop()
  }
}
</script>

</body>
</html>
