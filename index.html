<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Teleprompter Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #080808;
  --surface: #111113;
  --surface2: #1a1a1e;
  --border: rgba(255,255,255,0.07);
  --accent: #00e5ff;
  --accent2: #ff3d6b;
  --red: #ff3333;
  --text: #f0f0f0;
  --muted: #666;
  --panel-w: 280px;
  --radius: 14px;
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

html, body {
  width:100%; height:100%;
  background: var(--bg);
  color: var(--text);
  overflow: hidden;
  font-family: 'DM Sans', sans-serif;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
}

#editor-wrap {
  position: relative;
  height: 22vh;
  min-height: 80px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  transition: height .35s cubic-bezier(.4,0,.2,1);
  overflow: hidden;
}
body.hide-editor #editor-wrap { height: 0; }

#editor-label {
  position: absolute;
  top: 10px; left: 14px;
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--muted);
  font-family: 'DM Mono', monospace;
  pointer-events: none;
}

#editor {
  width: 100%; height: 100%;
  padding: 32px 14px 14px;
  background: transparent;
  color: var(--text);
  border: none;
  outline: none;
  resize: none;
  font-size: 15px;
  line-height: 1.6;
  font-family: 'DM Mono', monospace;
}
#editor::selection { background: rgba(0,229,255,0.2); }

#stage {
  position: relative;
  height: 78vh;
  transition: height .35s cubic-bezier(.4,0,.2,1);
  overflow: hidden;
}
body.hide-editor #stage { height: 100vh; }

#camera {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  object-fit: cover;
  transform: scaleX(-1);
}

#stage::before {
  content:'';
  position: absolute; inset: 0;
  background: linear-gradient(
    to bottom,
    rgba(0,0,0,.55) 0%,
    rgba(0,0,0,.15) 30%,
    rgba(0,0,0,.15) 70%,
    rgba(0,0,0,.55) 100%
  );
  z-index: 1;
  pointer-events: none;
}

#reading-zone {
  position: absolute;
  width: 100%;
  height: 160px;
  overflow: hidden;
  top: 38%;
  z-index: 5;
  pointer-events: none;
}

#reading-zone::before,
#reading-zone::after {
  content:'';
  position: absolute;
  left: 5%; right: 5%;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
  opacity: 0.5;
  z-index: 6;
}
#reading-zone::before { top: 0; }
#reading-zone::after { bottom: 0; }

#teleprompter {
  font-family: 'DM Sans', sans-serif;
  font-weight: 500;
  font-size: 42px;
  line-height: 1.25;
  max-width: 88%;
  margin: auto;
  text-align: center;
  white-space: pre-wrap;
  color: #fff;
  text-shadow:
    0 0 30px rgba(0,0,0,.9),
    0 0 60px rgba(0,0,0,.6),
    0 2px 4px rgba(0,0,0,.8);
  will-change: transform;
}

#status-bar {
  position: absolute;
  top: 14px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
  display: flex;
  align-items: center;
  gap: 10px;
}

.status-pill {
  background: rgba(0,0,0,.65);
  backdrop-filter: blur(12px);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 6px 14px;
  font-size: 12px;
  font-family: 'DM Mono', monospace;
  letter-spacing: 1px;
  color: var(--muted);
  transition: .3s;
}

#rec-pill {
  display: flex; align-items: center; gap: 7px;
  opacity: 0;
  transition: opacity .3s;
}
#rec-pill.active { opacity: 1; }
#rec-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--red);
  animation: blink 1s ease-in-out infinite;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

#timer-display {
  font-family: 'DM Mono', monospace;
  font-size: 13px;
  color: var(--text);
  opacity: 0;
  transition: opacity .3s;
}
#timer-display.active { opacity: 1; }

.corner-btn {
  position: absolute;
  top: 14px;
  z-index: 10;
  background: rgba(0,0,0,.6);
  backdrop-filter: blur(12px);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 8px 14px;
  font-size: 13px;
  cursor: pointer;
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  transition: all .2s;
}
.corner-btn:hover { background: rgba(255,255,255,.1); border-color: rgba(255,255,255,.15); }
#settingsBtn { left: 14px; }
#textBtn { right: 14px; }

#mirrorBtn {
  position: absolute;
  top: 14px;
  right: 100px;
  z-index: 10;
}

.controls {
  position: fixed;
  bottom: 28px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 20;
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border);
  border-radius: 60px;
  padding: 10px 20px;
}

.ctrl-btn {
  width: 52px; height: 52px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text);
  font-size: 18px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .2s;
  position: relative;
  overflow: hidden;
}
.ctrl-btn::after {
  content:'';
  position:absolute; inset:0; border-radius:50%;
  background: white;
  opacity:0;
  transition: opacity .15s;
}
.ctrl-btn:active::after { opacity: .15; }
.ctrl-btn:hover { transform: scale(1.06); }

#playBtn { background: #1a1a1e; border-color: rgba(0,229,255,.4); }
#playBtn.playing { background: rgba(0,229,255,.15); border-color: var(--accent); }
#stopBtn { background: #1a1a1e; }
#recBtn { background: rgba(255,51,51,.15); border-color: rgba(255,51,51,.5); color: var(--red); }
#stopRecBtn { background: #1a1a1e; color: var(--muted); }

.ctrl-divider {
  width: 1px; height: 30px;
  background: var(--border);
}

#speed-display {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  color: var(--muted);
  text-align: center;
  min-width: 36px;
  line-height: 1.3;
}
#speed-display span { display:block; font-size:16px; color:var(--text); }

#countdown {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Bebas Neue', cursive;
  font-size: 200px;
  color: var(--text);
  background: rgba(0,0,0,.7);
  backdrop-filter: blur(4px);
  z-index: 50;
  opacity: 0;
  pointer-events: none;
  transition: opacity .3s;
}
#countdown.show { opacity: 1; pointer-events: auto; }
#countdown-num {
  transform: scale(0.5);
  transition: transform .15s cubic-bezier(.34,1.56,.64,1);
}
#countdown.show #countdown-num { transform: scale(1); }

#panel {
  position: fixed;
  left: calc(-1 * var(--panel-w) - 10px);
  top: 0; bottom: 0;
  width: var(--panel-w);
  background: rgba(10,10,12,.92);
  backdrop-filter: blur(24px);
  border-right: 1px solid var(--border);
  padding: 0;
  z-index: 40;
  transition: left .35s cubic-bezier(.4,0,.2,1);
  display: flex; flex-direction: column;
  overflow: hidden;
}
#panel.open { left: 0; }

#panel-header {
  padding: 20px 20px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--muted);
  font-family: 'DM Mono', monospace;
}

.panel-section { padding: 20px; border-bottom: 1px solid var(--border); }
.panel-label {
  font-size: 11px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--muted);
  font-family: 'DM Mono', monospace;
  margin-bottom: 12px;
}
.panel-value {
  float: right;
  color: var(--accent);
}

input[type=range] {
  -webkit-appearance: none;
  width: 100%;
  height: 4px;
  border-radius: 2px;
  background: var(--surface2);
  outline: none;
  cursor: pointer;
  margin-top: 4px;
  clear: both;
  display: block;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px; height: 18px;
  border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 10px rgba(0,229,255,.4);
  cursor: pointer;
  transition: transform .15s;
}
input[type=range]::-webkit-slider-thumb:active { transform: scale(1.3); }
input[type=range]::-moz-range-thumb {
  width: 18px; height: 18px;
  border-radius: 50%;
  background: var(--accent);
  border: none;
  cursor: pointer;
}

.color-row {
  display: flex; gap: 10px; margin-top: 10px;
}
.color-swatch {
  width: 32px; height: 32px;
  border-radius: 8px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all .2s;
}
.color-swatch.active { border-color: white; transform: scale(1.15); }

.panel-toggle-row {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 8px;
}
.toggle {
  position: relative;
  width: 40px; height: 22px;
}
.toggle input { opacity:0; width:0; height:0; }
.toggle-slider {
  position: absolute; inset: 0;
  background: var(--surface2);
  border-radius: 11px;
  cursor: pointer;
  transition: .3s;
  border: 1px solid var(--border);
}
.toggle-slider::before {
  content:'';
  position: absolute;
  width: 16px; height: 16px;
  left: 2px; top: 2px;
  background: var(--muted);
  border-radius: 50%;
  transition: .3s;
}
.toggle input:checked + .toggle-slider { background: rgba(0,229,255,.2); border-color: var(--accent); }
.toggle input:checked + .toggle-slider::before { transform: translateX(18px); background: var(--accent); }

#overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.4);
  z-index: 35;
  opacity: 0;
  pointer-events: none;
  transition: opacity .35s;
  backdrop-filter: blur(2px);
}
#overlay.show { opacity: 1; pointer-events: auto; }

#pos-slider-wrap {
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  z-index: 10;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}
#pos-slider-label {
  font-family: 'DM Mono', monospace;
  font-size: 9px;
  letter-spacing: 1.5px;
  color: var(--accent);
  text-transform: uppercase;
  writing-mode: vertical-rl;
  transform: rotate(180deg);
  opacity: 0.7;
}
#pos-slider-val {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  color: var(--accent);
  background: rgba(0,0,0,.6);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(0,229,255,.3);
  border-radius: 8px;
  padding: 3px 6px;
  min-width: 36px;
  text-align: center;
}
#pos-slider-track {
  position: relative;
  width: 6px;
  height: 160px;
  background: rgba(255,255,255,.08);
  border-radius: 3px;
  border: 1px solid var(--border);
  cursor: pointer;
}
#pos-slider-fill {
  position: absolute;
  bottom: 0;
  left: 0; right: 0;
  border-radius: 3px;
  background: linear-gradient(to top, var(--accent), rgba(0,229,255,.3));
  transition: height .1s;
  pointer-events: none;
}
#pos-slider-thumb {
  position: absolute;
  left: 50%;
  transform: translate(-50%, 50%);
  width: 18px; height: 18px;
  border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 10px rgba(0,229,255,.6), 0 0 20px rgba(0,229,255,.2);
  border: 2px solid rgba(255,255,255,.3);
  cursor: grab;
  transition: box-shadow .2s, transform .15s;
  bottom: 0%;
}
#pos-slider-thumb:active { cursor: grabbing; transform: translate(-50%, 50%) scale(1.25); }

#speed-touch-hint {
  position: absolute;
  bottom: 100px; left: 50%;
  transform: translateX(-50%);
  font-size: 11px;
  color: var(--muted);
  font-family: 'DM Mono', monospace;
  opacity: 0;
  transition: opacity .5s;
  z-index: 10;
  letter-spacing: 1px;
  pointer-events: none;
}

@media (max-width: 600px) {
  #teleprompter { font-size: 32px; max-width: 95%; }
  .ctrl-btn { width: 46px; height: 46px; font-size: 16px; }
  #speed-display { display: none; }
  .ctrl-divider { display: none; }
  .controls { gap: 8px; padding: 8px 14px; }
}
</style>
</head>
<body>

<div id="editor-wrap">
  <span id="editor-label">SCRIPT</span>
  <textarea id="editor">"La Isapre es más cara…"

Depende.

Si ganas 1.800.000,
tu 7% son 126.000.

Con eso puedes tener acceso
a clínicas privadas,
reembolsos en menos de 48 horas,
y beneficios adicionales.

No es más caro.
Es distinto.</textarea>
</div>

<div id="stage">

  <div id="settingsBtn" class="corner-btn">⚙ Config</div>
  <div id="mirrorBtn" class="corner-btn">⇄</div>
  <div id="textBtn" class="corner-btn">✎ Script</div>

  <div id="status-bar">
    <div id="rec-pill" class="status-pill">
      <div id="rec-dot"></div>
      <span>REC</span>
    </div>
    <div id="timer-display" class="status-pill">00:00</div>
  </div>

  <video id="camera" autoplay playsinline muted></video>

  <div id="reading-zone">
    <div id="teleprompter"></div>
  </div>

  <div id="countdown">
    <div id="countdown-num">5</div>
  </div>

  <div id="speed-touch-hint">↕ DESLIZA PARA VELOCIDAD</div>

  <div id="pos-slider-wrap">
    <div id="pos-slider-val">38%</div>
    <div id="pos-slider-track">
      <div id="pos-slider-fill" style="height:38%"></div>
      <div id="pos-slider-thumb" style="bottom:38%"></div>
    </div>
    <div id="pos-slider-label">Posición</div>
  </div>

</div>

<div class="controls">
  <button class="ctrl-btn" id="playBtn" title="Play / Pause">▶</button>
  <button class="ctrl-btn" id="stopBtn" title="Detener">⏹</button>
  <div class="ctrl-divider"></div>
  <button class="ctrl-btn" id="recBtn" title="Grabar (cuenta regresiva)">●</button>
  <button class="ctrl-btn" id="stopRecBtn" title="Detener grabación">■</button>
  <div class="ctrl-divider"></div>
  <div id="speed-display">VEL<span id="speed-val">120</span></div>
</div>

<div id="overlay"></div>

<div id="panel">
  <div id="panel-header">⚙ Configuración</div>

  <div class="panel-section">
    <div class="panel-label">Velocidad <span class="panel-value" id="speed-lbl">120 px/s</span></div>
    <input type="range" min="20" max="350" value="120" id="speedControl">
  </div>

  <div class="panel-section">
    <div class="panel-label">Tamaño texto <span class="panel-value" id="font-lbl">42px</span></div>
    <input type="range" min="22" max="72" value="42" id="fontControl">
  </div>

  <div class="panel-section">
    <div class="panel-label">Posición lectura <span class="panel-value" id="pos-lbl">38%</span></div>
    <input type="range" min="0" max="100" value="38" id="positionControl">
  </div>

  <div class="panel-section">
    <div class="panel-label">Color texto</div>
    <div class="color-row">
      <div class="color-swatch active" style="background:#ffffff" data-color="#ffffff"></div>
      <div class="color-swatch" style="background:#00e5ff" data-color="#00e5ff"></div>
      <div class="color-swatch" style="background:#ffd54f" data-color="#ffd54f"></div>
      <div class="color-swatch" style="background:#a5d6a7" data-color="#a5d6a7"></div>
      <div class="color-swatch" style="background:#ef9a9a" data-color="#ef9a9a"></div>
    </div>
  </div>

  <div class="panel-section">
    <div class="panel-label">Cuenta regresiva <span class="panel-value" id="cd-lbl">5s</span></div>
    <input type="range" min="0" max="10" value="5" id="countdownControl">
  </div>

  <div class="panel-section">
    <div class="panel-label">Espejo cámara</div>
    <div class="panel-toggle-row">
      <span style="font-size:13px;color:var(--muted)">Voltear imagen</span>
      <label class="toggle">
        <input type="checkbox" id="mirrorToggle" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>
  </div>

  <div class="panel-section">
    <div class="panel-label">Auto-play al grabar</div>
    <div class="panel-toggle-row">
      <span style="font-size:13px;color:var(--muted)">Iniciar scroll al grabar</span>
      <label class="toggle">
        <input type="checkbox" id="autoPlayToggle" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>
  </div>
</div>

<script>
let speed = 120
let y = 0
let isPlaying = false
let isPaused = false
let lastTime = null
let raf = null
let mediaRecorder = null
let recordedChunks = []
let countdownSecs = 5
let timerInterval = null
let recSeconds = 0
let isMirrored = true
let touchStartY = null

const tele = document.getElementById('teleprompter')
const readingZone = document.getElementById('reading-zone')
const camEl = document.getElementById('camera')
const countdownEl = document.getElementById('countdown')
const countdownNum = document.getElementById('countdown-num')
const panel = document.getElementById('panel')
const overlay = document.getElementById('overlay')
const recPill = document.getElementById('rec-pill')
const timerDisp = document.getElementById('timer-display')
const playBtn = document.getElementById('playBtn')
const speedVal = document.getElementById('speed-val')

async function initCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user' }, audio: true })
    camEl.srcObject = stream
    window.appStream = stream
  } catch (e) {
    console.warn('Camera error:', e)
    document.getElementById('stage').style.background = '#0a0a0c'
  }
}
initCamera()

function setMirror(val) {
  isMirrored = val
  camEl.style.transform = val ? 'scaleX(-1)' : 'scaleX(1)'
}
document.getElementById('mirrorToggle').addEventListener('change', e => setMirror(e.target.checked))
document.getElementById('mirrorBtn').addEventListener('click', () => {
  isMirrored = !isMirrored
  setMirror(isMirrored)
  document.getElementById('mirrorToggle').checked = isMirrored
})

function play() {
  if (isPlaying && !isPaused) {
    isPaused = true
    isPlaying = false
    playBtn.innerHTML = '▶'
    playBtn.classList.remove('playing')
    return
  }
  if (isPaused) {
    isPaused = false
    isPlaying = true
    playBtn.innerHTML = '⏸'
    playBtn.classList.add('playing')
    lastTime = null
    requestAnimationFrame(loop)
    return
  }
  const raw = document.getElementById('editor').value
  if (!raw.trim()) return
  tele.innerText = raw
  y = readingZone.offsetHeight + 80
  tele.style.transform = `translateY(${y}px)`
  isPlaying = true
  isPaused = false
  playBtn.innerHTML = '⏸'
  playBtn.classList.add('playing')
  lastTime = null
  raf = requestAnimationFrame(loop)
}

function stop() {
  isPlaying = false
  isPaused = false
  if (raf) cancelAnimationFrame(raf)
  y = 0
  const raw = document.getElementById('editor').value
  tele.innerText = raw
  tele.style.transform = 'translateY(0)'
  playBtn.innerHTML = '▶'
  playBtn.classList.remove('playing')
}

function loop(timestamp) {
  if (!isPlaying) return
  if (!lastTime) lastTime = timestamp
  const delta = (timestamp - lastTime) / 1000
  lastTime = timestamp
  y -= speed * delta
  tele.style.transform = `translateY(${y}px)`
  raf = requestAnimationFrame(loop)
}

playBtn.addEventListener('click', play)
document.getElementById('stopBtn').addEventListener('click', stop)

document.addEventListener('keydown', e => {
  if (document.activeElement === document.getElementById('editor')) return
  if (e.code === 'Space') { e.preventDefault(); play(); }
  if (e.code === 'Escape') stop()
  if (e.code === 'ArrowUp') { speed = Math.min(350, speed + 10); updateSpeedUI(); }
  if (e.code === 'ArrowDown') { speed = Math.max(20, speed - 10); updateSpeedUI(); }
})

document.getElementById('recBtn').addEventListener('click', startCountdown)
document.getElementById('stopRecBtn').addEventListener('click', stopRecording)

function startCountdown() {
  let val = countdownSecs
  if (val === 0) { startRecording(); return; }
  countdownNum.innerText = val
  countdownEl.classList.add('show')
  const iv = setInterval(() => {
    val--
    countdownNum.innerText = val || '¡GO!'
    countdownNum.style.transform = 'scale(0.5)'
    requestAnimationFrame(() => {
      requestAnimationFrame(() => countdownNum.style.transform = 'scale(1)')
    })
    if (val <= 0) {
      clearInterval(iv)
      setTimeout(() => {
        countdownEl.classList.remove('show')
        startRecording()
      }, 600)
    }
  }, 1000)
}

function startRecording() {
  if (!window.appStream) return
  recordedChunks = []
  const mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus')
    ? 'video/webm;codecs=vp9,opus'
    : MediaRecorder.isTypeSupported('video/webm')
    ? 'video/webm'
    : 'video/mp4'
  mediaRecorder = new MediaRecorder(window.appStream, { mimeType })
  mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data) }
  mediaRecorder.onstop = saveVideo
  mediaRecorder.start(100)
  recPill.classList.add('active')
  recSeconds = 0
  timerDisp.innerText = '00:00'
  timerDisp.classList.add('active')
  timerInterval = setInterval(() => {
    recSeconds++
    const m = String(Math.floor(recSeconds/60)).padStart(2,'0')
    const s = String(recSeconds%60).padStart(2,'0')
    timerDisp.innerText = `${m}:${s}`
  }, 1000)
  document.body.classList.add('hide-editor')
  if (document.getElementById('autoPlayToggle').checked && !isPlaying) play()
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop()
  clearInterval(timerInterval)
  recPill.classList.remove('active')
  timerDisp.classList.remove('active')
  document.body.classList.remove('hide-editor')
}

function saveVideo() {
  const ext = (recordedChunks[0]?.type || 'video/webm').includes('mp4') ? 'mp4' : 'webm'
  const blob = new Blob(recordedChunks, { type: recordedChunks[0]?.type || 'video/webm' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `teleprompter_${new Date().toISOString().slice(0,19).replace(/[:.]/g,'-')}.${ext}`
  a.click()
  setTimeout(() => URL.revokeObjectURL(url), 5000)
}

function togglePanel() {
  panel.classList.toggle('open')
  overlay.classList.toggle('show')
}
document.getElementById('settingsBtn').addEventListener('click', togglePanel)
overlay.addEventListener('click', togglePanel)

document.getElementById('textBtn').addEventListener('click', () => {
  document.body.classList.toggle('hide-editor')
})

function updateSpeedUI() {
  speedVal.innerText = speed
  document.getElementById('speed-lbl').innerText = speed + ' px/s'
  document.getElementById('speedControl').value = speed
}

document.getElementById('speedControl').addEventListener('input', e => {
  speed = parseFloat(e.target.value)
  updateSpeedUI()
})

document.getElementById('fontControl').addEventListener('input', e => {
  const v = e.target.value
  tele.style.fontSize = v + 'px'
  document.getElementById('font-lbl').innerText = v + 'px'
})

document.getElementById('positionControl').addEventListener('input', e => {
  setPosFromPercent(parseFloat(e.target.value))
})

document.getElementById('countdownControl').addEventListener('input', e => {
  countdownSecs = parseInt(e.target.value)
  document.getElementById('cd-lbl').innerText = countdownSecs + 's'
})

document.querySelectorAll('.color-swatch').forEach(sw => {
  sw.addEventListener('click', () => {
    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'))
    sw.classList.add('active')
    tele.style.color = sw.dataset.color
    if (sw.dataset.color !== '#ffffff') {
      tele.style.textShadow = `0 0 30px rgba(0,0,0,.9), 0 0 60px rgba(0,0,0,.6), 0 0 20px ${sw.dataset.color}44`
    } else {
      tele.style.textShadow = '0 0 30px rgba(0,0,0,.9), 0 0 60px rgba(0,0,0,.6), 0 2px 4px rgba(0,0,0,.8)'
    }
  })
})

const posTrack  = document.getElementById('pos-slider-track')
const posThumb  = document.getElementById('pos-slider-thumb')
const posFill   = document.getElementById('pos-slider-fill')
const posValLbl = document.getElementById('pos-slider-val')
let posDragging = false

function setPosFromPercent(pct) {
  pct = Math.max(0, Math.min(100, pct))
  readingZone.style.top = pct + '%'
  posThumb.style.bottom = pct + '%'
  posFill.style.height  = pct + '%'
  posValLbl.innerText   = Math.round(pct) + '%'
  document.getElementById('positionControl').value = pct
  document.getElementById('pos-lbl').innerText = Math.round(pct) + '%'
}

function getPctFromEvent(clientY) {
  const rect = posTrack.getBoundingClientRect()
  const relY  = rect.bottom - clientY
  return (relY / rect.height) * 100
}

posTrack.addEventListener('mousedown', e => {
  posDragging = true
  setPosFromPercent(getPctFromEvent(e.clientY))
  e.preventDefault()
})
posThumb.addEventListener('mousedown', e => {
  posDragging = true
  e.preventDefault()
  e.stopPropagation()
})
document.addEventListener('mousemove', e => {
  if (!posDragging) return
  setPosFromPercent(getPctFromEvent(e.clientY))
})
document.addEventListener('mouseup', () => { posDragging = false })

posTrack.addEventListener('touchstart', e => {
  posDragging = true
  setPosFromPercent(getPctFromEvent(e.touches[0].clientY))
  e.stopPropagation()
}, { passive: true })
posThumb.addEventListener('touchstart', e => {
  posDragging = true
  e.stopPropagation()
}, { passive: true })
document.addEventListener('touchmove', e => {
  if (!posDragging) return
  setPosFromPercent(getPctFromEvent(e.touches[0].clientY))
}, { passive: true })
document.addEventListener('touchend', () => { posDragging = false }, { passive: true })

const stage = document.getElementById('stage')
const hint = document.getElementById('speed-touch-hint')
let hintTimer

stage.addEventListener('touchstart', e => {
  if (e.touches.length === 1) touchStartY = e.touches[0].clientY
}, { passive: true })

stage.addEventListener('touchmove', e => {
  if (touchStartY === null || posDragging) return
  const dy = touchStartY - e.touches[0].clientY
  speed = Math.max(20, Math.min(350, speed + dy * 0.3))
  touchStartY = e.touches[0].clientY
  updateSpeedUI()
  clearTimeout(hintTimer)
  hint.style.opacity = '1'
  hintTimer = setTimeout(() => hint.style.opacity = '0', 1500)
}, { passive: true })

stage.addEventListener('touchend', () => { touchStartY = null }, { passive: true })

let lastTap = 0
stage.addEventListener('touchend', e => {
  if (posDragging) return
  const now = Date.now()
  if (now - lastTap < 300) play()
  lastTap = now
}, { passive: true })
</script>
</body>
</html>
